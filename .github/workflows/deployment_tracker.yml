name: Track Merges into Beta (Linked PR Titles)

on:
  pull_request:
    types:
      - closed
    branches:
      - beta
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: read

jobs:
  track_prs:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load current date
        id: date
        run: echo "today=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Get merged PRs into beta with links
        id: get_prs
        run: |
          REPO="${{ github.repository }}"
          RAW_PRS=$(gh pr list --base beta --state merged --json number,title -L 100 -R "$REPO")
          FORMATTED_PRS=$(echo "$RAW_PRS" | jq -r --arg REPO "$REPO" '.[] | "  - [PR-\(.number) \(.title)](https://github.com/\($REPO)/pull/\(.number))"')

          if [ -z "$FORMATTED_PRS" ]; then
            echo "PRS=" >> $GITHUB_ENV
          else
            echo "PRS<<EOF" >> $GITHUB_ENV
            echo "$FORMATTED_PRS" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      - name: Load QA member usernames
        id: load_qa
        run: |
          FILE=".github/workflows/qa_members.txt"
          if [ ! -f "$FILE" ]; then
            echo "QA member list not found: $FILE"
            echo "MENTIONS=" >> $GITHUB_ENV
          else
            MENTIONS=$(grep -v '^#' "$FILE" | sed '/^$/d' | sed 's/^/@/' | paste -sd ' ' -)
            echo "MENTIONS=$MENTIONS" >> $GITHUB_ENV
          fi

      - name: Create GitHub Issue for QA
        if: env.PRS != ''
        run: |
          TITLE="PRs Merged into Beta - ${today}"
          {
            echo "${MENTIONS} Please begin QA testing on the listed PRs."
            echo
            echo "The following PRs have been merged into **beta** on ${today}:"
            echo
            echo "${PRS}"
          } > issue_body.md

          cat issue_body.md

          gh issue create --title "$TITLE" --body-file issue_body.md -R ${{ github.repository }}
